<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navigation Bar -->
    <nav
      class="bg-white shadow-lg border-b border-gray-200 fixed top-0 left-0 right-0 z-50"
    >
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
          <h1 class="text-xl font-bold text-gray-800">Survey Server</h1>
          <div class="flex items-center space-x-4">
            <span id="username" class="text-gray-600"></span>
            <button
              onclick="window.location.href='dashboard.html'"
              class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"
            >
              Back to Dashboard
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
      <!-- Alert Messages -->
      <div id="success-message" class="hidden mb-6"></div>
      <div id="error-message" class="hidden mb-6"></div>

      <!-- Loading State -->
      <div id="loading" class="hidden text-center py-8">
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
        ></div>
        <p class="mt-2 text-gray-600">Loading survey...</p>
      </div>

      <!-- Survey Content -->
      <div id="surveyContent" class="hidden">
        <!-- Survey Details Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div class="border-b pb-4 mb-4">
            <h1
              id="surveyTitle"
              class="text-2xl font-bold text-gray-900 mb-2"
            ></h1>
            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
              <span
                >Area: <span id="surveyArea" class="font-medium"></span
              ></span>
              <span
                >Expires: <span id="surveyExpiry" class="font-medium"></span
              ></span>
              <span
                >Status: <span id="surveyStatus" class="font-medium"></span
              ></span>
              <span
                >Responses: <span id="responseCount" class="font-medium"></span
              ></span>
            </div>
          </div>

          <!-- Survey Question -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">
              Survey Question
            </h3>
            <div
              id="surveyQuestion"
              class="bg-gray-50 p-4 rounded-lg text-gray-800"
            ></div>
          </div>

          <!-- Permitted Domains -->
          <div id="permittedDomainsSection" class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">
              Permitted Domains
            </h3>
            <div id="permittedDomains" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Response Guidelines -->
          <div id="responseGuidelinesSection" class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">
              Response Guidelines
            </h3>
            <div
              id="responseGuidelines"
              class="bg-blue-50 p-4 rounded-lg text-blue-900"
            ></div>
          </div>
        </div>

        <!-- Response Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            Your Response
          </h3>

          <!-- Existing Response Display -->
          <div id="existingResponseSection" class="hidden mb-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <div class="flex justify-between items-start mb-3">
                <h4 class="font-medium text-green-800">
                  Your Submitted Response
                </h4>
                <span id="responseDate" class="text-sm text-green-600"></span>
              </div>
              <div
                id="existingResponseContent"
                class="text-green-700 mb-4"
              ></div>
              <div id="responseActions" class="flex gap-2">
                <button
                  id="editResponseBtn"
                  onclick="startEditingResponse()"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                >
                  Edit Response
                </button>
                <button
                  id="deleteResponseBtn"
                  onclick="deleteUserResponse()"
                  class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                >
                  Delete Response
                </button>
              </div>
            </div>
          </div>

          <!-- Response Form -->
          <div id="responseFormSection" class="hidden">
            <form id="responseForm" class="space-y-4">
              <div>
                <label
                  for="responseContent"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  <span id="formLabel">Submit Your Response</span>
                </label>
                <textarea
                  id="responseContent"
                  rows="6"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                  placeholder="Enter your response here..."
                  maxlength="2000"
                ></textarea>
                <div class="text-right text-xs text-gray-500 mt-1">
                  <span id="charCount">0</span>/2000 characters
                </div>
              </div>

              <div class="flex gap-3">
                <button
                  type="submit"
                  id="submitBtn"
                  class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  <span id="submitBtnText">Submit Response</span>
                </button>
                <button
                  type="button"
                  id="cancelBtn"
                  onclick="cancelEditing()"
                  class="hidden bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>

          <!-- Survey Closed Message -->
          <div id="surveyClosedSection" class="hidden">
            <div
              class="bg-gray-100 border border-gray-300 rounded-lg p-4 text-center"
            >
              <div class="text-gray-600">
                <svg
                  class="w-12 h-12 mx-auto mb-3 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                  />
                </svg>
                <h4 class="text-lg font-medium mb-2">Survey Closed</h4>
                <p id="closedReason">
                  This survey is no longer accepting responses.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!-- Scripts -->
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
      // Global variables
      let currentSurvey = null;
      let userResponse = null;
      let isEditMode = false;

      // Initialize survey page function for auth.js
      function initializeSurveyPage() {
        // Check authentication
        if (!isLoggedIn()) {
          redirectToLogin();
          return;
        }

        // Update user info in navbar
        updateUserInfo();

        // Get survey ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const surveyId = urlParams.get("id");

        if (!surveyId) {
          showError("No survey ID provided");
          return;
        }

        // Load survey data
        loadSurvey(surveyId);

        // Setup form handlers
        setupFormHandlers();
      }

      /**
       * Update user info in the navbar
       */
      function updateUserInfo() {
        const user = getUserInfo();
        const usernameElement = document.getElementById("username");
        if (user && usernameElement) {
          usernameElement.textContent = user.username || "User";
        }
      }

      /**
       * Load survey data from API
       */
      async function loadSurvey(surveyId) {
        try {
          showLoading(true);

          const response = await authenticatedFetch(
            `${API_BASE_URL}/surveys/${surveyId}`
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message || "Failed to load survey"
            );
          }

          const data = await response.json();
          currentSurvey = data.survey;

          // Find user's response if exists
          const user = getUserInfo();
          userResponse = currentSurvey.responses?.find(
            (r) => (r.user._id || r.user) === user.userId
          );

          displaySurvey();
        } catch (error) {
          console.error("Error loading survey:", error);
          showError("Failed to load survey: " + error.message);
        } finally {
          showLoading(false);
        }
      }

      /**
       * Display survey data in the UI
       */
      function displaySurvey() {
        // Show survey content
        document.getElementById("surveyContent").classList.remove("hidden");

        // Display basic survey info
        document.getElementById("surveyTitle").textContent =
          currentSurvey.title || "Untitled Survey";
        document.getElementById("surveyArea").textContent =
          currentSurvey.area || "General";
        document.getElementById("surveyExpiry").textContent = formatDate(
          currentSurvey.expiryDate
        );
        document.getElementById("responseCount").textContent =
          currentSurvey.responses?.length || 0;

        // Display survey question
        const question =
          currentSurvey.guidelines?.question ||
          currentSurvey.question ||
          "No question provided";
        document.getElementById("surveyQuestion").textContent = question;

        // Display permitted domains
        const domains = currentSurvey.guidelines?.permittedDomains || [];
        const domainsContainer = document.getElementById("permittedDomains");
        if (domains.length > 0) {
          domainsContainer.innerHTML = domains
            .map(
              (domain) =>
                `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">${escapeHtml(
                  domain
                )}</span>`
            )
            .join("");
        } else {
          document
            .getElementById("permittedDomainsSection")
            .classList.add("hidden");
        }

        // Display response guidelines
        const guidelines = currentSurvey.guidelines?.permittedResponses;
        if (guidelines) {
          document.getElementById("responseGuidelines").textContent =
            guidelines;
        } else {
          document
            .getElementById("responseGuidelinesSection")
            .classList.add("hidden");
        }

        // Determine survey status and response capability
        const now = new Date();
        const expiryDate = new Date(currentSurvey.expiryDate);
        const isExpired = now > expiryDate;
        const isActive = currentSurvey.isActive !== false;
        const canRespond = isActive && !isExpired;

        // Update status display
        const statusElement = document.getElementById("surveyStatus");
        if (canRespond) {
          statusElement.textContent = "Active";
          statusElement.className = "font-medium text-green-600";
        } else if (!isActive) {
          statusElement.textContent = "Closed by Creator";
          statusElement.className = "font-medium text-red-600";
        } else {
          statusElement.textContent = "Expired";
          statusElement.className = "font-medium text-gray-600";
        }

        // Display appropriate response section
        displayResponseSection(canRespond);
      }

      /**
       * Display the appropriate response section based on survey state
       */
      function displayResponseSection(canRespond) {
        const existingSection = document.getElementById(
          "existingResponseSection"
        );
        const formSection = document.getElementById("responseFormSection");
        const closedSection = document.getElementById("surveyClosedSection");

        // Hide all sections initially
        existingSection.classList.add("hidden");
        formSection.classList.add("hidden");
        closedSection.classList.add("hidden");

        if (userResponse) {
          // User has already responded
          displayExistingResponse();
          if (canRespond) {
            // Show edit/delete options if survey is still open
            document
              .getElementById("responseActions")
              .classList.remove("hidden");
          } else {
            // Hide edit/delete options if survey is closed
            document.getElementById("responseActions").classList.add("hidden");
          }
        } else if (canRespond) {
          // User hasn't responded and survey is open
          showResponseForm(false);
        } else {
          // Survey is closed and user hasn't responded
          showClosedMessage();
        }
      }

      /**
       * Display existing response
       */
      function displayExistingResponse() {
        const existingSection = document.getElementById(
          "existingResponseSection"
        );
        document.getElementById("existingResponseContent").textContent =
          userResponse.content;
        document.getElementById("responseDate").textContent =
          "Submitted on " + formatDate(userResponse.createdAt);
        existingSection.classList.remove("hidden");
      }

      /**
       * Show response form
       */
      function showResponseForm(isEdit = false) {
        const formSection = document.getElementById("responseFormSection");
        const formLabel = document.getElementById("formLabel");
        const submitBtnText = document.getElementById("submitBtnText");
        const cancelBtn = document.getElementById("cancelBtn");

        formLabel.textContent = isEdit
          ? "Edit Your Response"
          : "Submit Your Response";
        submitBtnText.textContent = isEdit
          ? "Update Response"
          : "Submit Response";

        if (isEdit) {
          document.getElementById("responseContent").value =
            userResponse.content;
          updateCharCount();
          cancelBtn.classList.remove("hidden");
          isEditMode = true;
        } else {
          document.getElementById("responseContent").value = "";
          updateCharCount();
          cancelBtn.classList.add("hidden");
          isEditMode = false;
        }

        formSection.classList.remove("hidden");
      }

      /**
       * Show closed survey message
       */
      function showClosedMessage() {
        const closedSection = document.getElementById("surveyClosedSection");
        const closedReason = document.getElementById("closedReason");

        const now = new Date();
        const expiryDate = new Date(currentSurvey.expiryDate);
        const isExpired = now > expiryDate;

        if (!currentSurvey.isActive) {
          closedReason.textContent =
            "This survey has been closed by the creator.";
        } else if (isExpired) {
          closedReason.textContent =
            "This survey has expired and is no longer accepting responses.";
        }

        closedSection.classList.remove("hidden");
      }

      /**
       * Setup form event handlers
       */
      function setupFormHandlers() {
        // Character counter
        const textarea = document.getElementById("responseContent");
        textarea.addEventListener("input", updateCharCount);

        // Form submission
        const form = document.getElementById("responseForm");
        form.addEventListener("submit", handleFormSubmit);
      }

      /**
       * Update character count
       */
      function updateCharCount() {
        const textarea = document.getElementById("responseContent");
        const charCount = document.getElementById("charCount");
        const currentLength = textarea.value.length;
        charCount.textContent = currentLength;

        if (currentLength > 1900) {
          charCount.parentElement.className =
            "text-right text-xs text-red-500 mt-1";
        } else {
          charCount.parentElement.className =
            "text-right text-xs text-gray-500 mt-1";
        }
      }

      /**
       * Handle form submission
       */
      async function handleFormSubmit(event) {
        event.preventDefault();

        const content = document.getElementById("responseContent").value.trim();

        if (!content) {
          showError("Please enter your response before submitting");
          return;
        }

        if (content.length > 2000) {
          showError("Response is too long (maximum 2000 characters)");
          return;
        }

        try {
          const submitBtn = document.getElementById("submitBtn");
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Submitting...";

          if (isEditMode) {
            await updateResponse(content);
          } else {
            await submitResponse(content);
          }
        } catch (error) {
          console.error("Error with response:", error);
          showError(error.message);
        } finally {
          const submitBtn = document.getElementById("submitBtn");
          submitBtn.disabled = false;
          submitBtn.textContent =
            document.getElementById("submitBtnText").textContent;
        }
      }

      /**
       * Submit new response
       */
      async function submitResponse(content) {
        const response = await authenticatedFetch(
          `${API_BASE_URL}/surveys/${currentSurvey._id}/responses`,
          {
            method: "POST",
            body: JSON.stringify({ content }),
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(
            errorData.error?.message || "Failed to submit response"
          );
        }

        const responseData = await response.json();
        userResponse = responseData;

        showSuccess("Response submitted successfully!");

        // Refresh the display
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      }

      /**
       * Update existing response
       */
      async function updateResponse(content) {
        const response = await authenticatedFetch(
          `${API_BASE_URL}/surveys/${currentSurvey._id}/responses/${userResponse._id}`,
          {
            method: "PUT",
            body: JSON.stringify({ content }),
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(
            errorData.error?.message || "Failed to update response"
          );
        }

        const responseData = await response.json();
        userResponse = responseData;

        showSuccess("Response updated successfully!");

        // Refresh the display
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      }

      /**
       * Start editing existing response
       */
      function startEditingResponse() {
        document
          .getElementById("existingResponseSection")
          .classList.add("hidden");
        showResponseForm(true);
      }

      /**
       * Cancel editing
       */
      function cancelEditing() {
        document.getElementById("responseFormSection").classList.add("hidden");
        if (userResponse) {
          displayExistingResponse();
        }
        isEditMode = false;
      }

      /**
       * Delete user's response
       */
      async function deleteUserResponse() {
        if (
          !confirm(
            "Are you sure you want to delete your response? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const response = await authenticatedFetch(
            `${API_BASE_URL}/surveys/${currentSurvey._id}/responses/${userResponse._id}`,
            {
              method: "DELETE",
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message || "Failed to delete response"
            );
          }

          showSuccess("Response deleted successfully!");

          // Refresh the page
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } catch (error) {
          console.error("Error deleting response:", error);
          showError("Failed to delete response: " + error.message);
        }
      }

      /**
       * Show/hide loading state
       */
      function showLoading(show) {
        const loadingElement = document.getElementById("loading");
        const contentElement = document.getElementById("surveyContent");

        if (show) {
          loadingElement.classList.remove("hidden");
          contentElement.classList.add("hidden");
        } else {
          loadingElement.classList.add("hidden");
          contentElement.classList.remove("hidden");
        }
      }

      /**
       * Format date for display
       */
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      /**
       * Escape HTML to prevent XSS
       */
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
